
from pathlib import Path

import numpy as np

from ..elements import ELEMENT_DICT

# Taken directly from the original Fortran implementation at
# https://www.chemiebn.uni-bonn.de/pctc/mulliken-center/software/dft-d3/dft-d3
# Some of the values don't match with the Pyykkö and Atsumi paper, but let's use
# these values to be consistent with the original implementation...
R_COV = np.array([
   0.32, 0.46, 1.20, 0.94, 0.77, 0.75, 0.71, 0.63, 0.64, 0.67,
   1.40, 1.25, 1.13, 1.04, 1.10, 1.02, 0.99, 0.96, 1.76, 1.54,
   1.33, 1.22, 1.21, 1.10, 1.07, 1.04, 1.00, 0.99, 1.01, 1.09,
   1.12, 1.09, 1.15, 1.10, 1.14, 1.17, 1.89, 1.67, 1.47, 1.39,
   1.32, 1.24, 1.15, 1.13, 1.13, 1.08, 1.15, 1.23, 1.28, 1.26,
   1.26, 1.23, 1.32, 1.31, 2.09, 1.76, 1.62, 1.47, 1.58, 1.57,
   1.56, 1.55, 1.51, 1.52, 1.51, 1.50, 1.49, 1.49, 1.48, 1.53,
   1.46, 1.37, 1.31, 1.23, 1.18, 1.16, 1.11, 1.12, 1.13, 1.32,
   1.30, 1.30, 1.36, 1.31, 1.38, 1.42, 2.01, 1.81, 1.67, 1.58,
   1.52, 1.53, 1.54, 1.55
])
'''
Covalent radii in Ångströms according to `Pyykkö and Atsumi
<https://doi.org/10.1002/chem.200800987>`_.
Values for metals reduced by 10% for use in Grimme-D3.
'''

# Also directly copied from https://www.chemiebn.uni-bonn.de/pctc/mulliken-center/software/dft-d3/dft-d3
R4R2 = np.array([
     2.00734898,  1.56637132,  5.01986934, 3.85379032,  3.64446594,
     3.10492822,  2.71175247,  2.59361680, 2.38825250,  2.21522516,
     6.58585536,  5.46295967,  5.65216669, 4.88284902,  4.29727576,
     4.04108902,  3.72932356,  3.44677275, 7.97762753,  7.07623947,
     6.60844053,  6.28791364,  6.07728703, 5.54643096,  5.80491167,
     5.58415602,  5.41374528,  5.28497229, 5.22592821,  5.09817141,
     6.12149689,  5.54083734,  5.06696878, 4.87005108,  4.59089647,
     4.31176304,  9.55461698,  8.67396077, 7.97210197,  7.43439917,
     6.58711862,  6.19536215,  6.01517290, 5.81623410,  5.65710424,
     5.52640661,  5.44263305,  5.58285373, 7.02081898,  6.46815523,
     5.98089120,  5.81686657,  5.53321815, 5.25477007, 11.02204549,
    10.15679528,  9.35167836,  9.06926079, 8.97241155,  8.90092807,
     8.85984840,  8.81736827,  8.79317710, 7.89969626,  8.80588454,
     8.42439218,  8.54289262,  8.47583370, 8.45090888,  8.47339339,
     7.83525634,  8.20702843,  7.70559063, 7.32755997,  7.03887381,
     6.68978720,  6.05450052,  5.88752022, 5.70661499,  5.78450695,
     7.79780729,  7.26443867,  6.78151984, 6.67883169,  6.39024318,
     6.09527958, 11.79156076, 11.10997644, 9.51377795,  8.67197068,
     8.77140725,  8.65402716,  8.53923501, 8.85024712  
])
'''
sqrt(0.5*sqrt(Z)<r4>/<r2>(Z)) values for Grimme-D3.
'''

REF_CN = np.array([
    [+0.9118, +0.0000, -1.0000, -1.0000, -1.0000],  # H
    [+0.0000, -1.0000, -1.0000, -1.0000, -1.0000],  # He
    [+0.0000, +0.9865, -1.0000, -1.0000, -1.0000],  # Li
    [+0.0000, +0.9808, +1.9697, -1.0000, -1.0000],  # Be
    [+0.0000, +0.9706, +1.9441, +2.9128, +4.5856],  # B
    [+0.0000, +0.9868, +1.9985, +2.9987, +3.9844],  # C
    [+0.0000, +0.9944, +2.0143, +2.9903, -1.0000],  # N
    [+0.0000, +0.9925, +1.9887, -1.0000, -1.0000],  # O
    [+0.0000, +0.9982, -1.0000, -1.0000, -1.0000],  # F
    [+0.0000, -1.0000, -1.0000, -1.0000, -1.0000],  # Ne
    [+0.0000, +0.9684, -1.0000, -1.0000, -1.0000],  # Na
    [+0.0000, +0.9628, +1.9496, -1.0000, -1.0000],  # Mg
    [+0.0000, +0.9648, +1.9311, +2.9146, -1.0000],  # Al
    [+0.0000, +0.9507, +1.9435, +2.9407, +3.8677],  # Si
    [+0.0000, +0.9947, +2.0102, +2.9859, -1.0000],  # P
    [+0.0000, +0.9948, +1.9903, -1.0000, -1.0000],  # S
    [+0.0000, +0.9972, -1.0000, -1.0000, -1.0000],  # Cl
    [+0.0000, -1.0000, -1.0000, -1.0000, -1.0000],  # Ar
    [+0.0000, +0.9767, -1.0000, -1.0000, -1.0000],  # K
    [+0.0000, +0.9831, +1.9349, -1.0000, -1.0000],  # Ca
    [+0.0000, +1.8627, +2.8999, -1.0000, -1.0000],  # Sc
    [+0.0000, +1.8299, +3.8675, -1.0000, -1.0000],  # Ti
    [+0.0000, +1.9138, +2.9110, -1.0000, -1.0000],  # V
    [+0.0000, +1.8269, 10.6191, -1.0000, -1.0000],  # Cr
    [+0.0000, +1.6406, +9.8849, -1.0000, -1.0000],  # Mn
    [+0.0000, +1.6483, +9.1376, -1.0000, -1.0000],  # Fe
    [+0.0000, +1.7149, +2.9263, +7.7785, -1.0000],  # Co
    [+0.0000, +1.7937, +6.5458, +6.2918, -1.0000],  # Ni
    [+0.0000, +0.9576, -1.0000, -1.0000, -1.0000],  # Cu
    [+0.0000, +1.9419, -1.0000, -1.0000, -1.0000],  # Zn
    [+0.0000, +0.9601, +1.9315, +2.9233, -1.0000],  # Ga
    [+0.0000, +0.9434, +1.9447, +2.9186, +3.8972],  # Ge
    [+0.0000, +0.9889, +1.9793, +2.9709, -1.0000],  # As
    [+0.0000, +0.9901, +1.9812, -1.0000, -1.0000],  # Se
    [+0.0000, +0.9974, -1.0000, -1.0000, -1.0000],  # Br
    [+0.0000, -1.0000, -1.0000, -1.0000, -1.0000],  # Kr
    [+0.0000, +0.9738, -1.0000, -1.0000, -1.0000],  # Rb
    [+0.0000, +0.9801, +1.9143, -1.0000, -1.0000],  # Sr
    [+0.0000, +1.9153, +2.8903, -1.0000, -1.0000],  # Y
    [+0.0000, +1.9355, +3.9106, -1.0000, -1.0000],  # Zr
    [+0.0000, +1.9545, +2.9225, -1.0000, -1.0000],  # Nb
    [+0.0000, +1.9420, 11.0556, -1.0000, -1.0000],  # Mo
    [+0.0000, +1.6682, +9.5402, -1.0000, -1.0000],  # Tc
    [+0.0000, +1.8584, +8.8895, -1.0000, -1.0000],  # Ru
    [+0.0000, +1.9003, +2.9696, -1.0000, -1.0000],  # Rh
    [+0.0000, +1.8630, +5.7095, -1.0000, -1.0000],  # Pd
    [+0.0000, +0.9679, -1.0000, -1.0000, -1.0000],  # Ag
    [+0.0000, +1.9539, -1.0000, -1.0000, -1.0000],  # Cd
    [+0.0000, +0.9633, +1.9378, +2.9353, -1.0000],  # In
    [+0.0000, +0.9514, +1.9505, +2.9259, +3.9123],  # Sn
    [+0.0000, +0.9749, +1.9523, +2.9315, -1.0000],  # Sb
    [+0.0000, +0.9811, +1.9639, -1.0000, -1.0000],  # Te
    [+0.0000, +0.9968, -1.0000, -1.0000, -1.0000],  # I
    [+0.0000, -1.0000, -1.0000, -1.0000, -1.0000],  # Xe
    [+0.0000, +0.9909, -1.0000, -1.0000, -1.0000],  # Cs
    [+0.0000, +0.9797, +1.8467, -1.0000, -1.0000],  # Ba
    [+0.0000, +1.9373, +2.9175, -1.0000, -1.0000],  # La
    [+2.7991, -1.0000, -1.0000, -1.0000, -1.0000],  # Ce
    [+0.0000, +2.9425, -1.0000, -1.0000, -1.0000],  # Pr
    [+0.0000, +2.9455, -1.0000, -1.0000, -1.0000],  # Nd
    [+0.0000, +2.9413, -1.0000, -1.0000, -1.0000],  # Pm
    [+0.0000, +2.9300, -1.0000, -1.0000, -1.0000],  # Sm
    [+0.0000, +1.8286, -1.0000, -1.0000, -1.0000],  # Eu
    [+0.0000, +2.8732, -1.0000, -1.0000, -1.0000],  # Gd
    [+0.0000, +2.9086, -1.0000, -1.0000, -1.0000],  # Tb
    [+0.0000, +2.8965, -1.0000, -1.0000, -1.0000],  # Dy
    [+0.0000, +2.9242, -1.0000, -1.0000, -1.0000],  # Ho
    [+0.0000, +2.9282, -1.0000, -1.0000, -1.0000],  # Er
    [+0.0000, +2.9246, -1.0000, -1.0000, -1.0000],  # Tm
    [+0.0000, +2.8482, -1.0000, -1.0000, -1.0000],  # Yb
    [+0.0000, +2.9219, -1.0000, -1.0000, -1.0000],  # Lu
    [+0.0000, +1.9254, +3.8840, -1.0000, -1.0000],  # Hf
    [+0.0000, +1.9459, +2.8988, -1.0000, -1.0000],  # Ta
    [+0.0000, +1.9292, 10.9153, -1.0000, -1.0000],  # W
    [+0.0000, +1.8104, +9.8054, -1.0000, -1.0000],  # Re
    [+0.0000, +1.8858, +9.1527, -1.0000, -1.0000],  # Os
    [+0.0000, +1.8648, +2.9424, -1.0000, -1.0000],  # Ir
    [+0.0000, +1.9188, +6.6669, -1.0000, -1.0000],  # Pt
    [+0.0000, +0.9846, -1.0000, -1.0000, -1.0000],  # Au
    [+0.0000, +1.9896, -1.0000, -1.0000, -1.0000],  # Hg
    [+0.0000, +0.9267, +1.9302, +2.9420, -1.0000],  # Tl
    [+0.0000, +0.9383, +1.9356, +2.9081, +3.9098],  # Pb
    [+0.0000, +0.9820, +1.9655, +2.9500, -1.0000],  # Bi
    [+0.0000, +0.9815, +1.9639, -1.0000, -1.0000],  # Po
    [+0.0000, +0.9954, -1.0000, -1.0000, -1.0000],  # At
    [+0.0000, -1.0000, -1.0000, -1.0000, -1.0000],  # Rn
    [+0.0000, +0.9705, -1.0000, -1.0000, -1.0000],  # Fr
    [+0.0000, +0.9662, +1.8075, -1.0000, -1.0000],  # Ra
    [+0.0000, +2.9070, -1.0000, -1.0000, -1.0000],  # Ac
    [+0.0000, +2.8844, -1.0000, -1.0000, -1.0000],  # Th
    [+0.0000, +2.8738, -1.0000, -1.0000, -1.0000],  # Pa
    [+0.0000, +2.8878, -1.0000, -1.0000, -1.0000],  # U
    [+0.0000, +2.9095, -1.0000, -1.0000, -1.0000],  # Np
    [+0.0000, +1.9209, -1.0000, -1.0000, -1.0000],  # Pu
])
'''
Reference coordination numbers for Grimme-D3. Values from:
`<https://doi.org/10.1063/1.3382344>`_
'''

K1 = 16
'''
Factor in exponent of coordination number calculation for Grimme-D3.
'''

K2 = 4 / 3
'''
Scale factor for covalent radii in coordination number calculation for Grimme-D3.
'''

K3 = 4
'''
Factor in exponent of Gaussian weight function in reference coordination number
calculation for Grimme-D3.
'''

_REF_C6 = None
_R0_AB = None

def load_ref_c6():
    '''
    Load the reference C6 coefficient values for Grimme-D3. Values from:
    `<https://doi.org/10.1063/1.3382344>`_

    The returned array has shape (94, 94, 5, 5). The first two indices correspond
    to pairs of chemical elements, and the (5, 5) array of values contains the C6
    coeffiecients for the corresponding of reference coordination numbers stored in
    :data:`REF_CN`.

    Returns:
        ref_c6: numpy.ndarray of shape (94, 94, 5, 5). C6 coefficients.
    '''
    global _REF_C6
    if _REF_C6 is None:
        _REF_C6 = np.load(Path(__file__).parent / 'd3_c6.npy')
    return _REF_C6

def load_R0():
    '''
    Load cut-off radii values for Grimme-D3. Values from:
    `<https://doi.org/10.1063/1.3382344>`_

    Pairs of chemical elements have their own cut-off radii, corresponding to the
    two indices of the returned array.

    Returns:
        ref_c6: numpy.ndarray of shape (94, 94). Cut-off radii.
    '''
    global _R0_AB
    if _R0_AB is None:
        _R0_AB = np.load(Path(__file__).parent / 'd3_R0.npy')
    return _R0_AB
